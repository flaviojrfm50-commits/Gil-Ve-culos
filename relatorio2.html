<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Frota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://bzgvbghxmebdjqnlakbj.supabase.co",
  "sb_publishable_IyvZNwtgkvECR0QVlYbhzw_zPL1TMJv"
);

let empresaId;

/* ================= Pegar usuário ================= */
async function init(){

  const { data: { user } } = await supabase.auth.getUser();
  if(!user){
    alert("Faça login primeiro");
    return;
  }

  const { data: perfil } = await supabase
    .from("profiles")
    .select("empresa_id, role")
    .eq("id", user.id)
    .single();

  empresaId = perfil.empresa_id;

  if(perfil.role === "dono_frota" || perfil.role === "super_admin"){
    document.getElementById("areaVeiculo").style.display = "block";
  }

  carregarVeiculos();
  carregarLancamentos();
}

/* ================= CADASTRAR VEÍCULO ================= */
window.cadastrarVeiculo = async function(){

  const placa = document.getElementById("placa").value;
  const modelo = document.getElementById("modelo").value;

  if(!placa || !modelo){
    alert("Preencha todos os campos");
    return;
  }

  await supabase.from("veiculos").insert({
    empresa_id: empresaId,
    placa,
    modelo
  });

  document.getElementById("placa").value="";
  document.getElementById("modelo").value="";

  carregarVeiculos();
}

/* ================= LISTAR VEÍCULOS ================= */
async function carregarVeiculos(){

  const { data } = await supabase
    .from("veiculos")
    .select("*");

  const select = document.getElementById("selectVeiculo");
  select.innerHTML="";

  data.forEach(v=>{
    select.innerHTML += `<option value="${v.id}">${v.modelo} - ${v.placa}</option>`;
  });
}

/* ================= CADASTRAR LANÇAMENTO ================= */
window.cadastrarLancamento = async function(){

  const veiculo_id = document.getElementById("selectVeiculo").value;
  const valor = parseFloat(document.getElementById("valor").value) || 0;
  const despesa = parseFloat(document.getElementById("despesa").value) || 0;
  const descricao = document.getElementById("descricao").value;

  await supabase.from("lancamentos").insert({
    empresa_id: empresaId,
    veiculo_id,
    valor,
    despesa,
    descricao
  });

  document.getElementById("valor").value="";
  document.getElementById("despesa").value="";
  document.getElementById("descricao").value="";

  carregarLancamentos();
}

/* ================= LISTAR LANÇAMENTOS ================= */
async function carregarLancamentos(){

  const { data } = await supabase
    .from("lancamentos")
    .select("*, veiculos(modelo,placa)")
    .order("created_at", { ascending:false });

  let total = 0;
  const tabela = document.getElementById("tabela");
  tabela.innerHTML="";

  data.forEach(l=>{

    let lucro = l.valor - l.despesa;
    total += lucro;

    tabela.innerHTML += `
      <tr>
        <td>${l.veiculos?.modelo}</td>
        <td>${l.veiculos?.placa}</td>
        <td>${l.descricao}</td>
        <td>R$ ${l.valor}</td>
        <td>R$ ${l.despesa}</td>
        <td>R$ ${lucro}</td>
      </tr>
    `;
  });

  document.getElementById("total").innerText = total.toFixed(2);
}

window.onload = init;

</script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:20px}
.container{max-width:1000px;margin:auto;background:#fff;padding:20px;border-radius:10px}
h2{text-align:center}
input,select{padding:8px;margin:5px}
button{padding:8px 12px;background:#28a745;color:#fff;border:none;border-radius:5px}
table{width:100%;margin-top:20px;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#222;color:#fff}
</style>
</head>
<body>

<div class="container">

<h2>Controle Frota</h2>

<div id="areaVeiculo" style="display:none;">
<h3>Cadastrar Veículo</h3>
<input id="placa" placeholder="Placa">
<input id="modelo" placeholder="Modelo">
<button onclick="cadastrarVeiculo()">Salvar</button>
</div>

<h3>Lançamento</h3>
<select id="selectVeiculo"></select>
<input id="descricao" placeholder="Descrição">
<input type="number" id="valor" placeholder="Valor">
<input type="number" id="despesa" placeholder="Despesa">
<button onclick="cadastrarLancamento()">Salvar</button>

<table>
<thead>
<tr>
<th>Modelo</th>
<th>Placa</th>
<th>Descrição</th>
<th>Valor</th>
<th>Despesa</th>
<th>Lucro</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<h3>Total Lucro: R$ <span id="total">0.00</span></h3>

</div>

</body>
</html>
