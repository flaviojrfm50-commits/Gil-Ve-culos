<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Frota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const { jsPDF } = window.jspdf;

const supabase = createClient(
  "https://bzgvbghxmebdjqnlakbj.supabase.co",
  "sb_publishable_IyvZNwtgkvECR0QVlYbhzw_zPL1TMJv"
);

let dadosAtuais = [];

/* ================= CONVERTER REAL PARA NÚMERO ================= */
function converterRealParaNumero(valorDigitado){
  if(!valorDigitado) return 0;
  return Number(valorDigitado.replace(/\./g,'').replace(',','.')) || 0;
}

/* ================= FORMATAÇÃO AUTOMÁTICA MOEDA ================= */
function formatarMoeda(input){
  if(!input) return;
  input.addEventListener("input", function(e){
    let valor = e.target.value.replace(/\D/g,"");
    valor = (Number(valor) / 100).toFixed(2);
    valor = valor.replace(".",",");
    valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g,".");
    e.target.value = valor;
  });
}

/* ================= LOGIN ================= */
async function verificarSessao(){
  const loginBox = document.getElementById("loginBox");
  const sistema = document.getElementById("sistema");

  if(!loginBox || !sistema) return;

  const { data: { session } } = await supabase.auth.getSession();

  if(session){
    loginBox.style.display="none";
    sistema.style.display="block";
    carregarVeiculos();
    carregarLancamentos();
  } else {
    loginBox.style.display="block";
    sistema.style.display="none";
  }
}

window.login = async function(){
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: senha.value
  });
  if(error) return alert(error.message);
  verificarSessao();
}

window.cadastrarConta = async function(){
  const { error } = await supabase.auth.signUp({
    email: email.value,
    password: senha.value
  });
  if(error) return alert(error.message);
  alert("Conta criada!");
}

window.logout = async function(){
  await supabase.auth.signOut();
  verificarSessao();
}

/* ================= VEICULOS ================= */
window.cadastrarVeiculo = async function(){
  if(!placa.value || !modelo.value)
    return alert("Preencha placa e modelo");

  const { error } = await supabase.from("veiculos").insert({
    placa: placa.value.toUpperCase(),
    modelo: modelo.value
  });

  if(error) return alert(error.message);

  placa.value="";
  modelo.value="";
  carregarVeiculos();
}

async function carregarVeiculos(){
  const { data } = await supabase.from("veiculos").select("*");

  selectVeiculo.innerHTML="<option value=''>Selecione</option>";

  data?.forEach(v=>{
    selectVeiculo.innerHTML += `
      <option value="${v.id}">
        ${v.modelo} - ${v.placa}
      </option>
    `;
  });
}

/* ================= LANÇAMENTOS ================= */
window.cadastrarLancamento = async function(){

  if(!selectVeiculo.value || !dataInicio.value)
    return alert("Selecione veículo e data");

  const mes = new Date(dataInicio.value)
    .toLocaleString('pt-BR', { month:'long' });

  const { error } = await supabase.from("lancamentos").insert({
    veiculo_id: selectVeiculo.value,
    cliente: cliente.value,
    descricao: descricao.value,
    km_inicial: Number(kmInicial.value)||0,
    km_final: Number(kmFinal.value)||0,
    quantidade: Number(quantidade.value)||0,
    valor: converterRealParaNumero(valor.value),
    despesa: converterRealParaNumero(despesa.value),
    data_inicio: dataInicio.value,
    data_fim: dataFim.value,
    mes
  });

  if(error) return alert(error.message);

  limpar();
  carregarLancamentos();
}

async function carregarLancamentos(){

  const { data } = await supabase
    .from("lancamentos")
    .select("*, veiculos(modelo,placa)")
    .order("created_at",{ascending:false});

  dadosAtuais = data || [];

  tabela.innerHTML="";
  let total = 0;

  dadosAtuais.forEach(l=>{

    const km = (l.km_final||0)-(l.km_inicial||0);
    const lucro = (l.valor||0)-(l.despesa||0);
    total += lucro;

    tabela.innerHTML += `
    <tr>
      <td>${l.veiculos?.modelo||''}</td>
      <td>${l.veiculos?.placa||''}</td>
      <td>${l.mes||''}</td>
      <td>${l.km_inicial||0}</td>
      <td>${l.km_final||0}</td>
      <td>${km}</td>
      <td>${l.cliente||''}</td>
      <td>${l.descricao||''}</td>
      <td>R$ ${Number(l.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
      <td>R$ ${Number(l.despesa||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
      <td><b>R$ ${lucro.toLocaleString('pt-BR',{minimumFractionDigits:2})}</b></td>
      <td>
        <button onclick="gerarPDFLancamento('${l.id}')" style="background:#007bff">Linha</button>
        <button onclick="gerarPDFVeiculo('${l.veiculo_id}')" style="background:#6f42c1">Veículo</button>
        <button onclick="excluirLancamento('${l.id}')" style="background:#dc3545">X</button>
      </td>
    </tr>
    `;
  });

  totalSpan.innerText = total.toLocaleString('pt-BR',{minimumFractionDigits:2});
}

/* ================= PDF GERAL ================= */
window.gerarPDF = function(){

  const doc = new jsPDF();

  const colunas = [
    "Modelo","Placa","Mês","KM Inicial",
    "KM Final","KM Rodado","Cliente",
    "Descrição","Valor","Despesa","Lucro"
  ];

  let linhas = [];
  let total = 0;

  dadosAtuais.forEach(l=>{

    const km = (l.km_final||0)-(l.km_inicial||0);
    const lucro = (l.valor||0)-(l.despesa||0);
    total += lucro;

    linhas.push([
      l.veiculos?.modelo||'',
      l.veiculos?.placa||'',
      l.mes||'',
      l.km_inicial||0,
      l.km_final||0,
      km,
      l.cliente||'',
      l.descricao||'',
      "R$ "+Number(l.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+Number(l.despesa||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+lucro.toLocaleString('pt-BR',{minimumFractionDigits:2})
    ]);
  });

  doc.text("RELATÓRIO CONTROLE FROTA",14,15);

  doc.autoTable({
    head:[colunas],
    body:linhas,
    startY:20
  });

  doc.text(
    "TOTAL LUCRO: R$ "+total.toLocaleString('pt-BR',{minimumFractionDigits:2}),
    14,
    doc.lastAutoTable.finalY+10
  );

  doc.save("relatorio_frota.pdf");
}

/* ================= PDF LANÇAMENTO ================= */
window.gerarPDFLancamento = function(id){
  const l = dadosAtuais.find(x => x.id == id);
  if(!l) return;

  const doc = new jsPDF();
  const km = (l.km_final||0)-(l.km_inicial||0);
  const lucro = (l.valor||0)-(l.despesa||0);

  doc.text("RELATÓRIO DO LANÇAMENTO",14,15);

  doc.autoTable({
    startY:20,
    head:[["Campo","Valor"]],
    body:[
      ["Modelo", l.veiculos?.modelo||""],
      ["Placa", l.veiculos?.placa||""],
      ["Mês", l.mes||""],
      ["KM Rodado", km],
      ["Cliente", l.cliente||""],
      ["Descrição", l.descricao||""],
      ["Valor", "R$ "+Number(l.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})],
      ["Despesa", "R$ "+Number(l.despesa||0).toLocaleString('pt-BR',{minimumFractionDigits:2})],
      ["Lucro", "R$ "+lucro.toLocaleString('pt-BR',{minimumFractionDigits:2})]
    ]
  });

  doc.save("relatorio_lancamento.pdf");
}

/* ================= PDF VEÍCULO ================= */
window.gerarPDFVeiculo = function(veiculoId){

  const dadosFiltrados = dadosAtuais.filter(l => l.veiculo_id == veiculoId);

  if(dadosFiltrados.length === 0)
    return alert("Este veículo não possui lançamentos.");

  const doc = new jsPDF();

  const colunas = [
    "Modelo","Placa","Mês","KM Inicial",
    "KM Final","KM Rodado","Cliente",
    "Descrição","Valor","Despesa","Lucro"
  ];

  let linhas = [];
  let total = 0;

  dadosFiltrados.forEach(l=>{
    const km = (l.km_final||0)-(l.km_inicial||0);
    const lucro = (l.valor||0)-(l.despesa||0);
    total += lucro;

    linhas.push([
      l.veiculos?.modelo||'',
      l.veiculos?.placa||'',
      l.mes||'',
      l.km_inicial||0,
      l.km_final||0,
      km,
      l.cliente||'',
      l.descricao||'',
      "R$ "+Number(l.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+Number(l.despesa||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+lucro.toLocaleString('pt-BR',{minimumFractionDigits:2})
    ]);
  });

  doc.text("RELATÓRIO DO VEÍCULO",14,15);

  doc.autoTable({
    head:[colunas],
    body:linhas,
    startY:20
  });

  doc.text(
    "TOTAL LUCRO: R$ "+total.toLocaleString('pt-BR',{minimumFractionDigits:2}),
    14,
    doc.lastAutoTable.finalY+10
  );

  doc.save("relatorio_veiculo.pdf");
}

window.excluirLancamento = async function(id){
  if(!confirm("Excluir este lançamento?")) return;
  await supabase.from("lancamentos").delete().eq("id", id);
  carregarLancamentos();
}

function limpar(){
  document.querySelectorAll("#sistema input").forEach(i=>i.value="");
}

/* ================= INICIALIZAÇÃO ================= */
window.addEventListener("DOMContentLoaded", ()=>{
  formatarMoeda(document.getElementById("valor"));
  formatarMoeda(document.getElementById("despesa"));
  verificarSessao();
});
</script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:20px}
.container{max-width:1200px;margin:auto;background:#fff;padding:20px;border-radius:10px}

.topo{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:30px;
  margin-bottom:25px;
}

.banner-area img{
  width:100%;
  max-width:450px;
  height:160px;
  object-fit:cover;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.15);
}

h2{text-align:center}
input,select{padding:8px;margin:5px}
button{padding:8px 12px;background:#28a745;color:#fff;border:none;border-radius:5px}
table{width:100%;margin-top:20px;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:14px}
th{background:#222;color:#fff}
.login-box{max-width:400px;margin:auto;background:#fff;padding:20px;border-radius:10px}
</style>
</head>

<body>

<div id="loginBox" class="login-box">
<h2>Login</h2>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha"><br>
<button onclick="login()">Entrar</button>
<button onclick="cadastrarConta()">Criar Conta</button>
</div>

<div id="sistema" class="container" style="display:none">

<div class="topo">
  <div>
    <h2>Controle Frota Mensal</h2>
    <button onclick="logout()" style="background:#dc3545">Sair</button>
  </div>
  <div class="banner-area">
    <img src="banner.jpg" alt="Banner">
  </div>
</div>

<h3>Cadastrar Veículo</h3>
<input id="placa" placeholder="Placa">
<input id="modelo" placeholder="Modelo">
<button onclick="cadastrarVeiculo()">Salvar</button>
<button onclick="excluirVeiculo()" style="background:#dc3545">Excluir Veículo</button>

<h3>Novo Lançamento</h3>

<select id="selectVeiculo"></select>
<input type="date" id="dataInicio">
<input type="date" id="dataFim">
<input id="cliente" placeholder="Cliente">
<input id="descricao" placeholder="Descrição">
<input type="number" id="kmInicial" placeholder="KM Inicial">
<input type="number" id="kmFinal" placeholder="KM Final">
<input type="number" id="quantidade" placeholder="Quantidade">
<input id="valor" placeholder="Valor (R$)" inputmode="numeric">
<input id="despesa" placeholder="Despesa (R$)" inputmode="numeric">

<button onclick="cadastrarLancamento()">Salvar</button>
<button onclick="gerarPDF()" style="background:#007bff">Gerar PDF</button>

<table>
<thead>
<tr>
<th>Modelo</th>
<th>Placa</th>
<th>Mês</th>
<th>KM Inicial</th>
<th>KM Final</th>
<th>KM Rodado</th>
<th>Cliente</th>
<th>Descrição</th>
<th>Valor</th>
<th>Despesa</th>
<th>Lucro</th>
<th>Ação</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<h3>Total Lucro: R$ <span id="totalSpan">0,00</span></h3>

</div>

</body>
</html>
