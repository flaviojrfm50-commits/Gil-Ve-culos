<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ERP Frota MultiusuÃ¡rio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9;}
header{background:#111827;color:#fff;padding:15px;text-align:center;font-size:20px;}
.container{padding:20px;max-width:1400px;margin:auto;}
.card{background:#fff;padding:15px;border-radius:10px;
box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px;}
input,select{padding:8px;margin:5px;border-radius:6px;border:1px solid #ccc;}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;}
.btn-primary{background:#2563eb;color:#fff;}
.btn-success{background:#16a34a;color:#fff;}
.btn-danger{background:#dc2626;color:#fff;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#1f2937;color:#fff;}
</style>
</head>
<body>

<header>ERP FROTA SAAS</header>

<div id="loginBox" class="container">
<div class="card">
<h3>Login</h3>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha">
<button class="btn-primary" onclick="login()">Entrar</button>
</div>
</div>

<div id="sistema" style="display:none;">
<div class="container">

<div class="card">
<button class="btn-danger" onclick="logout()">Sair</button>
<h3>LanÃ§amento</h3>

<select id="selectVeiculo"></select>
<button class="btn-danger" onclick="removerVeiculo()">Remover</button>

<br>

<input type="date" id="dataInicio">
<input type="date" id="dataFim">

<br>

<input id="cliente" placeholder="Cliente">
<input id="descricao" placeholder="DescriÃ§Ã£o">
<input id="quantidade" type="number" placeholder="Qtd">
<input id="valor" type="number" placeholder="Valor">
<input id="despesa" type="number" placeholder="Despesa">
<input id="kmFinal" type="number" placeholder="KM Final">

<button class="btn-success" onclick="lancar()">Salvar</button>
<button class="btn-primary" onclick="gerarGrafico()">Dashboard</button>
<button class="btn-primary" onclick="gerarPDF()">PDF</button>
</div>

<div id="areaAdmin" class="card" style="display:none;">
<h3>Cadastrar UsuÃ¡rio</h3>

<input id="cadEmail" placeholder="Email">
<input id="cadSenha" type="password" placeholder="Senha">
<input id="cadNome" placeholder="Nome">

<select id="cadRole">
<option value="motorista">Motorista</option>
<option value="dono_frota">Dono da Frota</option>
</select>

<button onclick="cadastrarUsuario()">Cadastrar</button>
</div>

<div class="card">
<h3>RelatÃ³rio</h3>

<input type="date" id="filtroInicio">
<input type="date" id="filtroFim">
<button onclick="filtrarPeriodo()">Filtrar</button>

<table>
<thead>
<tr>
<th>VeÃ­culo</th>
<th>Cliente</th>
<th>KM Rodado</th>
<th>Lucro</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<h3>Total: R$ <span id="totalGeral">0.00</span></h3>

<canvas id="grafico"></canvas>

</div>
</div>
</div>

<script>

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// â— DECLARAÃ‡ÃƒO DO SUPABASE (UMA ÃšNICA VEZ)
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

if (!window.supabaseClient) {
  window.supabaseClient = window.supabase.createClient(
    "https://bzgvbghxmebdjqnlakbj.supabase.co",
    "sb_publishable_IyvZNwtgkvECR0QVlYbhzw_zPL1TMJv"
  );
}

const supabase = window.supabaseClient;


let usuarioAtual;
let perfilAtual;

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸ” LOGIN
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function login(){

  const { data, error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: senha.value
  });

  if(error){ alert(error.message); return; }

  usuarioAtual = data.user;

  const { data: perfil } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", usuarioAtual.id)
    .single();

  perfilAtual = perfil;

  if(perfil.role === "super_admin" || perfil.role === "dono_frota"){
    areaAdmin.style.display="block";
  }

  loginBox.style.display="none";
  sistema.style.display="block";

  carregarVeiculos();

}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸ” LOGOUT
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸš— CARREGAR VEÃCULOS
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function carregarVeiculos(){
  const { data } = await supabase.from("veiculos").select("*");
  selectVeiculo.innerHTML="";
  data.forEach(v=>{
    selectVeiculo.innerHTML+=`<option value="${v.id}">${v.nome}</option>`;
  });
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸ—‘ REMOVER VEÃCULO
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function removerVeiculo(){
  await supabase.from("veiculos")
    .delete()
    .eq("id",selectVeiculo.value);

  carregarVeiculos();
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸ“ BUSCAR ÃšLTIMO KM
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function buscarUltimoKM(id){
  const { data } = await supabase
    .from("lancamentos")
    .select("km_final")
    .eq("veiculo_id",id)
    .order("created_at",{ascending:false})
    .limit(1);

  if(data.length>0) return data[0].km_final;

  const { data: v } = await supabase
    .from("veiculos")
    .select("km_inicial")
    .eq("id",id)
    .single();

  return v.km_inicial;
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸ’¾ SALVAR LANÃ‡AMENTO
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function lancar(){

  let veiculo_id = selectVeiculo.value;
  let kmInicialAtual = await buscarUltimoKM(veiculo_id);

  await supabase.from("lancamentos").insert([{
    veiculo_id,
    cliente:cliente.value,
    descricao:descricao.value,
    quantidade:quantidade.value,
    valor:valor.value,
    despesa:despesa.value,
    km_inicial:kmInicialAtual,
    km_final:kmFinal.value,
    data_inicio:dataInicio.value,
    data_fim:dataFim.value,
    user_id:usuarioAtual.id
  }]);

  alert("Salvo!");
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸ“Š FILTRO POR PERÃODO
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function filtrarPeriodo(){

  const { data } = await supabase
    .from("lancamentos")
    .select(`*,veiculos(nome)`)
    .gte("data_inicio",filtroInicio.value)
    .lte("data_fim",filtroFim.value);

  montarTabela(data);
}

function montarTabela(data){
  tabela.innerHTML="";
  let total=0;

  data.forEach(item=>{
    let km=item.km_final-item.km_inicial;
    let lucro=item.valor-item.despesa;
    total+=lucro;

    tabela.innerHTML+=`
    <tr>
    <td>${item.veiculos.nome}</td>
    <td>${item.cliente}</td>
    <td>${km}</td>
    <td>R$ ${lucro}</td>
    </tr>`;
  });

  totalGeral.innerText=total.toFixed(2);
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸ“ˆ DASHBOARD
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function gerarGrafico(){

  const { data } = await supabase
    .from("lancamentos")
    .select(`valor,despesa,veiculos(nome)`);

  let resumo={};
  data.forEach(i=>{
    let lucro=i.valor-i.despesa;
    let nome=i.veiculos.nome;
    if(!resumo[nome]) resumo[nome]=0;
    resumo[nome]+=lucro;
  });

  new Chart(document.getElementById("grafico"),{
    type:"bar",
    data:{
      labels:Object.keys(resumo),
      datasets:[{label:"Lucro",data:Object.values(resumo)}]
    }
  });
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸ“„ PDF
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function gerarPDF(){

  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();

  const { data } = await supabase
    .from("lancamentos")
    .select(`*,veiculos(nome)`);

  let y=20;
  let total=0;

  doc.text("RELATÃ“RIO FROTA",20,10);

  data.forEach(i=>{
    let lucro=i.valor-i.despesa;
    total+=lucro;
    doc.text(`${i.veiculos.nome} - ${i.cliente} - R$ ${lucro}`,10,y);
    y+=7;
    if(y>270){doc.addPage();y=20;}
  });

  doc.text(`TOTAL: R$ ${total.toFixed(2)}`,10,y+10);
  doc.save("Relatorio_Frota.pdf");
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ğŸ‘¤ CADASTRAR USUÃRIO (ADMIN)
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

async function cadastrarUsuario(){

  if(perfilAtual.role !== "super_admin" &&
     perfilAtual.role !== "dono_frota"){
    alert("Sem permissÃ£o");
    return;
  }

  const { data: novoAuth, error } = await supabase.auth.signUp({
    email: cadEmail.value,
    password: cadSenha.value
  });

  if(error){ alert(error.message); return; }

  await supabase.from("profiles").insert([{
    id: novoAuth.user.id,
    empresa_id: perfilAtual.empresa_id,
    nome: cadNome.value,
    role: cadRole.value,
    ativo: true
  }]);

  alert("UsuÃ¡rio cadastrado!");
}

</script>
</body>
</html>
