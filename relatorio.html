<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Profissional Frota</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h2>Controle de Veículos</h2>

<h3>Cadastrar Veículo</h3>
<input id="nome" placeholder="Nome">
<input id="placa" placeholder="Placa">
<input id="kmInicial" type="number" placeholder="KM Inicial">
<button onclick="cadastrarVeiculo()">Salvar Veículo</button>

<hr>

<h3>Lançamento</h3>

<select id="selectVeiculo"></select>
<input id="cliente" placeholder="Cliente">
<input id="descricao" placeholder="Descrição">
<input id="quantidade" type="number" placeholder="Quantidade">
<input id="valor" type="number" placeholder="Valor">
<input id="despesa" type="number" placeholder="Despesa">
<input id="kmFinal" type="number" placeholder="KM Final">

<select id="mes">
<option>Janeiro</option>
<option>Fevereiro</option>
<option>Março</option>
<option>Abril</option>
<option>Maio</option>
<option>Junho</option>
<option>Julho</option>
<option>Agosto</option>
<option>Setembro</option>
<option>Outubro</option>
<option>Novembro</option>
<option>Dezembro</option>
</select>

<button onclick="lancar()">Salvar Lançamento</button>

<script>

const supabase = window.supabase.createClient(
  "https://bzgvbghxmebdjqnlakbj.supabase.co",
  "sb_publishable_IyvZNwtgkvECR0QVlYbhzw_zPL1TMJv"
);

async function carregarVeiculos(){
  const { data } = await supabase.from("veiculos").select("*");

  let select = document.getElementById("selectVeiculo");
  select.innerHTML = "";

  data.forEach(v=>{
    select.innerHTML += `<option value="${v.id}">${v.nome} - ${v.placa}</option>`;
  });
}

async function cadastrarVeiculo(){

  let nome = document.getElementById("nome").value;
  let placa = document.getElementById("placa").value;
  let kmInicial = document.getElementById("kmInicial").value;

  await supabase.from("veiculos").insert([
    { nome, placa, km_inicial: kmInicial }
  ]);

  alert("Veículo salvo!");
  carregarVeiculos();
}

async function buscarUltimoKM(veiculo_id){

  const { data } = await supabase
    .from("lancamentos")
    .select("km_final")
    .eq("veiculo_id", veiculo_id)
    .order("created_at", { ascending: false })
    .limit(1);

  if(data.length > 0){
    return data[0].km_final;
  }else{
    // se não tiver lançamento, pega km inicial do veículo
    const { data: veiculo } = await supabase
      .from("veiculos")
      .select("km_inicial")
      .eq("id", veiculo_id)
      .single();

    return veiculo.km_inicial;
  }
}

async function lancar(){

  let veiculo_id = document.getElementById("selectVeiculo").value;

  let cliente = document.getElementById("cliente").value;
  let descricao = document.getElementById("descricao").value;
  let quantidade = document.getElementById("quantidade").value;
  let valor = document.getElementById("valor").value;
  let despesa = document.getElementById("despesa").value;
  let kmFinal = document.getElementById("kmFinal").value;
  let mes = document.getElementById("mes").value;

  let kmInicial = await buscarUltimoKM(veiculo_id);

  await supabase.from("lancamentos").insert([
    {
      veiculo_id,
      cliente,
      descricao,
      quantidade,
      valor,
      despesa,
      km_inicial: kmInicial,
      km_final: kmFinal,
      mes
    }
  ]);

  alert("Lançamento salvo com KM automático!");
}

carregarVeiculos();

</script>

</body>
</html>
