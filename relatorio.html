<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Frota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const { jsPDF } = window.jspdf;

const supabase = createClient(
  "https://bzgvbghxmebdjqnlakbj.supabase.co",
  "sb_publishable_IyvZNwtgkvECR0QVlYbhzw_zPL1TMJv"
);

let dadosAtuais = [];

/* ================= LOGIN ELEMENTOS ================= */

const loginBox = document.getElementById("loginBox");
const sistema = document.getElementById("sistema");

/* ================= CONVERTER REAL ================= */

function converterRealParaNumero(valorDigitado){
  if(!valorDigitado) return 0;
  return Number(valorDigitado.replace(/\./g,'').replace(',','.')) || 0;
}

/* ================= FORMATAÇÃO MOEDA ================= */

function formatarMoeda(input){
  if(!input) return; // evita erro

  input.addEventListener("input", function(e){
    let valor = e.target.value.replace(/\D/g,"");
    valor = (Number(valor) / 100).toFixed(2);
    valor = valor.replace(".",",");
    valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g,".");
    e.target.value = valor;
  });
}

/* ================= LOGIN ================= */

async function verificarSessao(){

  const loginBox = document.getElementById("loginBox");
  const sistema = document.getElementById("sistema");

  const { data: { session } } = await supabase.auth.getSession();

  if(session){
    loginBox.style.display="none";
    sistema.style.display="block";
    carregarVeiculos();
    carregarLancamentos();
  } else {
    loginBox.style.display="block";
    sistema.style.display="none";
  }
}

window.login = async function(){
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: senha.value
  });
  if(error) return alert(error.message);
  verificarSessao();
}

window.cadastrarConta = async function(){
  const { error } = await supabase.auth.signUp({
    email: email.value,
    password: senha.value
  });
  if(error) return alert(error.message);
  alert("Conta criada!");
}

window.logout = async function(){
  await supabase.auth.signOut();
  verificarSessao();
}

/* ================= VEICULOS ================= */

window.cadastrarVeiculo = async function(){
  if(!placa.value || !modelo.value)
    return alert("Preencha placa e modelo");

  const { error } = await supabase.from("veiculos").insert({
    placa: placa.value.toUpperCase(),
    modelo: modelo.value
  });

  if(error) return alert(error.message);

  placa.value="";
  modelo.value="";
  carregarVeiculos();
}

async function carregarVeiculos(){
  const { data } = await supabase.from("veiculos").select("*");

  selectVeiculo.innerHTML="<option value=''>Selecione</option>";

  data?.forEach(v=>{
    selectVeiculo.innerHTML += `
      <option value="${v.id}">
        ${v.modelo} - ${v.placa}
      </option>
    `;
  });
}

/* ================= LANÇAMENTOS ================= */

window.cadastrarLancamento = async function(){

  if(!selectVeiculo.value || !dataInicio.value)
    return alert("Selecione veículo e data");

  const mes = new Date(dataInicio.value)
    .toLocaleString('pt-BR', { month:'long' });

  const { error } = await supabase.from("lancamentos").insert({
    veiculo_id: selectVeiculo.value,
    cliente: cliente.value,
    descricao: descricao.value,
    km_inicial: Number(kmInicial.value)||0,
    km_final: Number(kmFinal.value)||0,
    quantidade: Number(quantidade.value)||0,
    valor: converterRealParaNumero(valor.value),
    despesa: converterRealParaNumero(despesa.value),
    data_inicio: dataInicio.value,
    data_fim: dataFim.value,
    mes
  });

  if(error) return alert(error.message);

  limpar();
  carregarLancamentos();
}

async function carregarLancamentos(){

  const { data } = await supabase
    .from("lancamentos")
    .select("*, veiculos(modelo,placa)")
    .order("created_at",{ascending:false});

  dadosAtuais = data || [];

  tabela.innerHTML="";
  let total = 0;

  dadosAtuais.forEach(l=>{

    const km = (l.km_final||0)-(l.km_inicial||0);
    const lucro = (l.valor||0)-(l.despesa||0);
    total += lucro;

    tabela.innerHTML += `
    <tr>
      <td>${l.veiculos?.modelo||''}</td>
      <td>${l.veiculos?.placa||''}</td>
      <td>${l.mes||''}</td>
      <td>${l.km_inicial||0}</td>
      <td>${l.km_final||0}</td>
      <td>${km}</td>
      <td>${l.cliente||''}</td>
      <td>${l.descricao||''}</td>
      <td>R$ ${Number(l.valor||0).toFixed(2)}</td>
      <td>R$ ${Number(l.despesa||0).toFixed(2)}</td>
      <td><b>R$ ${lucro.toFixed(2)}</b></td>
      <td>
        <button onclick="gerarPDFLinha('${l.id}')" style="background:#007bff">Linha</button>
        <button onclick="gerarPDFVeiculo('${l.veiculo_id}')" style="background:#6f42c1">Veículo</button>
        <button onclick="excluirLancamento('${l.id}')" style="background:#dc3545">X</button>
      </td>
    </tr>
    `;
  });

  totalSpan.innerText = total.toFixed(2);
}

/* ================= RELATÓRIO LINHA ================= */

window.gerarPDFLinha = function(id){

  const lancamento = dadosAtuais.find(l => l.id == id);
  if(!lancamento) return;

  const doc = new jsPDF();

  const km = (lancamento.km_final||0)-(lancamento.km_inicial||0);
  const lucro = (lancamento.valor||0)-(lancamento.despesa||0);

  doc.text("RELATÓRIO INDIVIDUAL DO LANÇAMENTO",14,15);

  doc.autoTable({
    startY:20,
    head:[["Campo","Valor"]],
    body:[
      ["Modelo", lancamento.veiculos?.modelo||""],
      ["Placa", lancamento.veiculos?.placa||""],
      ["Mês", lancamento.mes||""],
      ["KM Inicial", lancamento.km_inicial||0],
      ["KM Final", lancamento.km_final||0],
      ["KM Rodado", km],
      ["Cliente", lancamento.cliente||""],
      ["Descrição", lancamento.descricao||""],
      ["Valor", "R$ "+Number(lancamento.valor||0).toFixed(2)],
      ["Despesa", "R$ "+Number(lancamento.despesa||0).toFixed(2)],
      ["Lucro", "R$ "+lucro.toFixed(2)]
    ]
  });

  doc.save("relatorio_linha.pdf");
}

/* ================= RELATÓRIO VEÍCULO ================= */

window.gerarPDFVeiculo = function(veiculoId){

  const dadosFiltrados = dadosAtuais.filter(
    l => l.veiculo_id == veiculoId
  );

  if(dadosFiltrados.length === 0)
    return alert("Este veículo não possui lançamentos.");

  const doc = new jsPDF();

  let total = 0;
  let linhas = [];

  dadosFiltrados.forEach(l=>{

    const km = (l.km_final||0)-(l.km_inicial||0);
    const lucro = (l.valor||0)-(l.despesa||0);
    total += lucro;

    linhas.push([
      l.mes,
      l.cliente,
      l.descricao,
      "R$ "+Number(l.valor||0).toFixed(2),
      "R$ "+Number(l.despesa||0).toFixed(2),
      "R$ "+lucro.toFixed(2)
    ]);
  });

  doc.text("RELATÓRIO DO VEÍCULO",14,15);

  doc.autoTable({
    startY:20,
    head:[["Mês","Cliente","Descrição","Valor","Despesa","Lucro"]],
    body:linhas
  });

  doc.text("TOTAL: R$ "+total.toFixed(2),14,doc.lastAutoTable.finalY+10);

  doc.save("relatorio_veiculo.pdf");
}

window.excluirLancamento = async function(id){
  if(!confirm("Excluir este lançamento?")) return;
  await supabase.from("lancamentos").delete().eq("id", id);
  carregarLancamentos();
}

function limpar(){
  document.querySelectorAll("#sistema input").forEach(i=>i.value="");
}

window.addEventListener("DOMContentLoaded", ()=>{
  formatarMoeda(document.getElementById("valor"));
  formatarMoeda(document.getElementById("despesa"));
});

window.onload = verificarSessao;

</script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:20px}
.container{max-width:1200px;margin:auto;background:#fff;padding:20px;border-radius:10px}
button{padding:6px 10px;color:#fff;border:none;border-radius:5px;cursor:pointer}
table{width:100%;margin-top:20px;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:14px}
th{background:#222;color:#fff}
.login-box{max-width:400px;margin:auto;background:#fff;padding:20px;border-radius:10px}
</style>
</head>
<body>
<!-- Seu HTML permanece igual abaixo -->
</body>
</html>
