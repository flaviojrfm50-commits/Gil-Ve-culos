<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Frota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const { jsPDF } = window.jspdf;

const supabase = createClient(
  "https://bzgvbghxmebdjqnlakbj.supabase.co",
  "sb_publishable_IyvZNwtgkvECR0QVlYbhzw_zPL1TMJv"
);

let dadosAtuais = [];

/* ================= UTIL ================= */

function converterRealParaNumero(valorDigitado){
  if(!valorDigitado) return 0;
  return Number(valorDigitado.replace(/\./g,'').replace(',','.')) || 0;
}

function formatarMoeda(input){
  input.addEventListener("input", function(e){
    let valor = e.target.value.replace(/\D/g,"");
    valor = (Number(valor) / 100).toFixed(2);
    valor = valor.replace(".",",");
    valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g,".");
    e.target.value = valor;
  });
}

/* ================= LOGIN ================= */

async function verificarSessao(){
  const { data: { session } } = await supabase.auth.getSession();

  if(session){
    loginBox.style.display="none";
    sistema.style.display="block";
    carregarVeiculos();
    carregarLancamentos();
  } else {
    loginBox.style.display="block";
    sistema.style.display="none";
  }
}

window.login = async function(){
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: senha.value
  });
  if(error) return alert(error.message);
  verificarSessao();
}

window.cadastrarConta = async function(){
  const { error } = await supabase.auth.signUp({
    email: email.value,
    password: senha.value
  });
  if(error) return alert(error.message);
  alert("Conta criada!");
}

window.logout = async function(){
  await supabase.auth.signOut();
  verificarSessao();
}

/* ================= VEICULOS ================= */

window.cadastrarVeiculo = async function(){
  if(!placa.value || !modelo.value)
    return alert("Preencha placa e modelo");

  const { error } = await supabase.from("veiculos").insert({
    placa: placa.value.toUpperCase(),
    modelo: modelo.value
  });

  if(error) return alert(error.message);

  placa.value="";
  modelo.value="";
  carregarVeiculos();
}

async function carregarVeiculos(){
  const { data } = await supabase.from("veiculos").select("*");
  selectVeiculo.innerHTML="<option value=''>Selecione</option>";

  data?.forEach(v=>{
    selectVeiculo.innerHTML += `
      <option value="${v.id}">
        ${v.modelo} - ${v.placa}
      </option>
    `;
  });
}

window.excluirVeiculo = async function(){
  const id = selectVeiculo.value;
  if(!id) return alert("Selecione um veÃ­culo");
  if(!confirm("Excluir veÃ­culo e todos lanÃ§amentos?")) return;

  await supabase.from("lancamentos").delete().eq("veiculo_id", id);
  await supabase.from("veiculos").delete().eq("id", id);

  carregarVeiculos();
  carregarLancamentos();
}

/* ================= LANÃ‡AMENTOS ================= */

window.cadastrarLancamento = async function(){

  if(!selectVeiculo.value || !dataInicio.value)
    return alert("Selecione veÃ­culo e data");

  const mes = new Date(dataInicio.value)
    .toLocaleString('pt-BR', { month:'long' });

  const { error } = await supabase.from("lancamentos").insert({
    veiculo_id: selectVeiculo.value,
    cliente: cliente.value,
    descricao: descricao.value,
    km_inicial: Number(kmInicial.value)||0,
    km_final: Number(kmFinal.value)||0,
    quantidade: Number(quantidade.value)||0,
    valor: converterRealParaNumero(valor.value),
    despesa: converterRealParaNumero(despesa.value),
    data_inicio: dataInicio.value,
    data_fim: dataFim.value,
    mes
  });

  if(error) return alert(error.message);

  limpar();
  carregarLancamentos();
}

async function carregarLancamentos(){

  const veiculoSelecionado = selectVeiculo.value;

  let query = supabase
    .from("lancamentos")
    .select("*, veiculos(modelo,placa)")
    .order("created_at",{ascending:false});

  // ðŸ”¥ FILTRO AQUI
  if(veiculoSelecionado){
    query = query.eq("veiculo_id", veiculoSelecionado);
  }

  const { data } = await query;

  dadosAtuais = data || [];
  tabela.innerHTML="";
  let totalValor = 0;
let totalDespesa = 0;
let totalLucro = 0;


  dadosAtuais.forEach(l=>{

    const km = (l.km_final||0)-(l.km_inicial||0);
    const lucro = (l.valor||0)-(l.despesa||0);
    totalValor += Number(l.valor || 0);
    totalDespesa += Number(l.despesa || 0);
    totalLucro += lucro;


    tabela.innerHTML += `
    <tr>
      <td>${l.veiculos?.modelo||''}</td>
      <td>${l.veiculos?.placa||''}</td>
      <td>${l.mes||''}</td>
      <td>${l.km_inicial||0}</td>
      <td>${l.km_final||0}</td>
      <td>${km}</td>
      <td>${l.cliente||''}</td>
      <td>${l.descricao||''}</td>
      <td>R$ ${Number(l.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
      <td>R$ ${Number(l.despesa||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
      <td><b>R$ ${lucro.toLocaleString('pt-BR',{minimumFractionDigits:2})}</b></td>
      <td>
        <button onclick="gerarPDFLancamento('${l.id}')" style="background:#007bff">PDF Linha</button>
        <button onclick="gerarPDFVeiculo('${l.veiculo_id}')" style="background:#6f42c1">PDF VeÃ­culo</button>
        <button onclick="excluirLancamento('${l.id}')" style="background:#dc3545">X</button>
      </td>
    </tr>`;
  });

  totalValorSpan.innerText = totalValor.toLocaleString('pt-BR',{minimumFractionDigits:2});
totalDespesaSpan.innerText = totalDespesa.toLocaleString('pt-BR',{minimumFractionDigits:2});
totalLucroSpan.innerText = totalLucro.toLocaleString('pt-BR',{minimumFractionDigits:2});

  atualizarFiltroMes();
}


 

window.excluirLancamento = async function(id){
  if(!confirm("Excluir este lanÃ§amento?")) return;
  await supabase.from("lancamentos").delete().eq("id", id);
  carregarLancamentos();
}

/* ================= PDF GERAL ================= */

/* ================= PDF GERAL ================= */

window.gerarPDF = function(){

  const doc = new jsPDF({orientation:"landscape"});

  const colunas = [
    "Modelo","Placa","MÃªs","KM Inicial",
    "KM Final","KM Rodado","Cliente",
    "DescriÃ§Ã£o","Valor","Despesa","Lucro"
  ];

  let linhas = [];
  let totalValor = 0;
  let totalDespesa = 0;
  let totalLucro = 0;

  dadosAtuais.forEach(l=>{
    const km = (l.km_final||0)-(l.km_inicial||0);
    const lucro = (l.valor||0)-(l.despesa||0);

    totalValor += Number(l.valor || 0);
    totalDespesa += Number(l.despesa || 0);
    totalLucro += lucro;

    linhas.push([
      l.veiculos?.modelo||'',
      l.veiculos?.placa||'',
      l.mes||'',
      l.km_inicial||0,
      l.km_final||0,
      km,
      l.cliente||'',
      l.descricao||'',
      "R$ "+Number(l.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+Number(l.despesa||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+lucro.toLocaleString('pt-BR',{minimumFractionDigits:2})
    ]);
  });

  doc.text("RELATÃ“RIO CONTROLE FROTA",14,15);

  doc.autoTable({
    head:[colunas],
    body:linhas,
    startY:20,
    styles:{fontSize:8},
    headStyles:{fillColor:[34,34,34]}
  });

  let posY = doc.lastAutoTable.finalY + 10;

  doc.text(
    "TOTAL VALOR: R$ " + totalValor.toLocaleString('pt-BR',{minimumFractionDigits:2}),
    14,
    posY
  );

  doc.text(
    "TOTAL DESPESA: R$ " + totalDespesa.toLocaleString('pt-BR',{minimumFractionDigits:2}),
    14,
    posY + 7
  );

  doc.text(
    "TOTAL LUCRO: R$ " + totalLucro.toLocaleString('pt-BR',{minimumFractionDigits:2}),
    14,
    posY + 14
  );

  doc.save("relatorio_frota.pdf");
};


/* ================= PDF LANÃ‡AMENTO ================= */

window.gerarPDFLancamento = function(id){
  const l = dadosAtuais.find(x => x.id == id);
  if(!l) return;

  const doc = new jsPDF();
  const km = (l.km_final||0)-(l.km_inicial||0);
  const lucro = (l.valor||0)-(l.despesa||0);

  doc.text("RELATÃ“RIO DO LANÃ‡AMENTO",14,15);

  doc.autoTable({
    startY:20,
    head:[["Campo","Valor"]],
    body:[
      ["Modelo", l.veiculos?.modelo||""],
      ["Placa", l.veiculos?.placa||""],
      ["MÃªs", l.mes||""],
      ["KM Inicial", l.km_inicial||0],
      ["KM Final", l.km_final||0],
      ["KM Rodado", km],
      ["Cliente", l.cliente||""],
      ["DescriÃ§Ã£o", l.descricao||""],
      ["Valor", "R$ "+Number(l.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})],
      ["Despesa", "R$ "+Number(l.despesa||0).toLocaleString('pt-BR',{minimumFractionDigits:2})],
      ["Lucro", "R$ "+lucro.toLocaleString('pt-BR',{minimumFractionDigits:2})]
    ]
  });

  doc.save("relatorio_lancamento.pdf");
};

/* ================= PDF VEÃCULO ================= */

window.gerarPDFVeiculo = function(veiculoId){

  const dadosFiltrados = dadosAtuais.filter(l => l.veiculo_id == veiculoId);
  if(dadosFiltrados.length === 0)
    return alert("Este veÃ­culo nÃ£o possui lanÃ§amentos.");

  const doc = new jsPDF({orientation:"landscape"});

  const colunas = [
    "Modelo","Placa","MÃªs","KM Inicial",
    "KM Final","KM Rodado","Cliente",
    "DescriÃ§Ã£o","Valor","Despesa","Lucro"
  ];

  let linhas = [];
  let total = 0;

  dadosFiltrados.forEach(l=>{
    const km = (l.km_final||0)-(l.km_inicial||0);
    const lucro = (l.valor||0)-(l.despesa||0);
    total += lucro;

    linhas.push([
      l.veiculos?.modelo||'',
      l.veiculos?.placa||'',
      l.mes||'',
      l.km_inicial||0,
      l.km_final||0,
      km,
      l.cliente||'',
      l.descricao||'',
      "R$ "+Number(l.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+Number(l.despesa||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+lucro.toLocaleString('pt-BR',{minimumFractionDigits:2})
    ]);
  });

  doc.text("RELATÃ“RIO DO VEÃCULO",14,15);

  doc.autoTable({
    head:[colunas],
    body:linhas,
    startY:20,
    styles:{fontSize:8},
    headStyles:{fillColor:[34,34,34]}
  });

  doc.text(
    "TOTAL LUCRO: R$ "+total.toLocaleString('pt-BR',{minimumFractionDigits:2}),
    14,
    doc.lastAutoTable.finalY+10
  );

  doc.save("relatorio_veiculo.pdf");
};

function limpar(){
  document.querySelectorAll("#sistema input").forEach(i=>i.value="");
}

/* ================= FILTRO MÃŠS ================= */

function atualizarFiltroMes(){
  const mesesUnicos = [...new Set(dadosAtuais.map(l => l.mes))];

  mesFiltro.innerHTML = `<option value="">Selecionar MÃªs</option>`;

  mesesUnicos.forEach(m=>{
    mesFiltro.innerHTML += `<option value="${m}">${m}</option>`;
  });
}

window.addEventListener("DOMContentLoaded", ()=>{

  formatarMoeda(document.getElementById("valor"));
  formatarMoeda(document.getElementById("despesa"));

  document.getElementById("selectVeiculo")
    .addEventListener("change", carregarLancamentos);

});




window.gerarPDFMes = function(){

  const mesSelecionado = mesFiltro.value;
  if(!mesSelecionado) return alert("Selecione um mÃªs");

  const dadosFiltrados = dadosAtuais.filter(l => l.mes === mesSelecionado);

  if(dadosFiltrados.length === 0)
    return alert("NÃ£o hÃ¡ registros para este mÃªs.");

  const doc = new jsPDF({orientation:"landscape"});

  const colunas = [
    "Modelo","Placa","MÃªs","KM Inicial",
    "KM Final","KM Rodado","Cliente",
    "DescriÃ§Ã£o","Valor","Despesa","Lucro"
  ];

  let linhas = [];
  let total = 0;

  dadosFiltrados.forEach(l=>{
    const km = (l.km_final||0)-(l.km_inicial||0);
    const lucro = (l.valor||0)-(l.despesa||0);
    total += lucro;

    linhas.push([
      l.veiculos?.modelo||'',
      l.veiculos?.placa||'',
      l.mes||'',
      l.km_inicial||0,
      l.km_final||0,
      km,
      l.cliente||'',
      l.descricao||'',
      "R$ "+Number(l.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+Number(l.despesa||0).toLocaleString('pt-BR',{minimumFractionDigits:2}),
      "R$ "+lucro.toLocaleString('pt-BR',{minimumFractionDigits:2})
    ]);
  });

  doc.text("RELATÃ“RIO MENSAL - "+mesSelecionado.toUpperCase(),14,15);

  doc.autoTable({
    head:[colunas],
    body:linhas,
    startY:20,
    styles:{fontSize:8},
    headStyles:{fillColor:[34,34,34]}
  });

  doc.text(
    "TOTAL DO MÃŠS: R$ "+total.toLocaleString('pt-BR',{minimumFractionDigits:2}),
    14,
    doc.lastAutoTable.finalY+10
  );

  doc.save("relatorio_"+mesSelecionado+".pdf");
}

window.onload = verificarSessao;

</script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:20px}
.container{max-width:1200px;margin:auto;background:#fff;padding:20px;border-radius:10px}
h2{text-align:center}
input,select{padding:8px;margin:5px}
button{padding:8px 12px;background:#28a745;color:#fff;border:none;border-radius:5px}
table{width:100%;margin-top:20px;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:14px}
th{background:#222;color:#fff}
.login-box{max-width:400px;margin:auto;background:#fff;padding:20px;border-radius:10px}

/* ===== BANNER ===== */
.banner-box{
  width:100%;
  max-width:250px;      /* mais largo */
  height:150px;         /* mais alto */
  margin:20px auto 30px auto;  /* centralizado */
  border-radius:15px;
  overflow:hidden;
  box-shadow:0 8px 20px rgba(0,0,0,0.15); /* efeito mais profissional */
}

.banner-box img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

</style>
</head>

<body>

<div id="loginBox" class="login-box">
<h2>Login</h2>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha"><br>
<button onclick="login()">Entrar</button>
<button onclick="cadastrarConta()">Criar Conta</button>
</div>

<div id="sistema" class="container" style="display:none">

<h2>Controle Frota Mensal</h2>
<button onclick="logout()" style="background:#dc3545">Sair</button>

<div class="banner-box">
  <img src="banner.jpg" alt="Banner">
</div>

<h3>Cadastrar VeÃ­culo</h3>
<input id="placa" placeholder="Placa">
<input id="modelo" placeholder="Modelo">
<button onclick="cadastrarVeiculo()">Salvar</button>
<button onclick="excluirVeiculo()" style="background:#dc3545">Excluir VeÃ­culo</button>

<h3>Novo LanÃ§amento</h3>

<select id="selectVeiculo"></select>
<input type="date" id="dataInicio">
<input type="date" id="dataFim">
<input id="cliente" placeholder="Cliente">
<input id="descricao" placeholder="DescriÃ§Ã£o">
<input type="number" id="kmInicial" placeholder="KM Inicial">
<input type="number" id="kmFinal" placeholder="KM Final">
<input type="number" id="quantidade" placeholder="Quantidade">
<input id="valor" placeholder="Valor (R$)" inputmode="numeric">
<input id="despesa" placeholder="Despesa (R$)" inputmode="numeric">

<button onclick="cadastrarLancamento()">Salvar</button>

<select id="mesFiltro">
  <option value="">Selecionar MÃªs</option>
</select>

<button onclick="gerarPDFMes()" style="background:#6f42c1">
  PDF por MÃªs
</button>

<button onclick="gerarPDF()" style="background:#007bff">
  Gerar PDF
</button>


<table>
<thead>
<tr>
<th>Modelo</th>
<th>Placa</th>
<th>MÃªs</th>
<th>KM Inicial</th>
<th>KM Final</th>
<th>KM Rodado</th>
<th>Cliente</th>
<th>DescriÃ§Ã£o</th>
<th>Valor</th>
<th>Despesa</th>
<th>Lucro</th>
<th>AÃ§Ã£o</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<h3>Total Valor: R$ <span id="totalValorSpan">0,00</span></h3>
<h3>Total Despesa: R$ <span id="totalDespesaSpan">0,00</span></h3>
<h3><b>Total Lucro: R$ <span id="totalLucroSpan">0,00</span></b></h3>


</div>

</body>
</html>
